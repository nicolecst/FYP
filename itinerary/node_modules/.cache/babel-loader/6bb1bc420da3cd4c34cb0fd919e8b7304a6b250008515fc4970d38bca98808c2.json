{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.FindOperation = void 0;\nconst error_1 = require(\"../error\");\nconst read_concern_1 = require(\"../read_concern\");\nconst sort_1 = require(\"../sort\");\nconst utils_1 = require(\"../utils\");\nconst command_1 = require(\"./command\");\nconst operation_1 = require(\"./operation\");\n/** @internal */\nclass FindOperation extends command_1.CommandOperation {\n  constructor(collection, ns, filter = {}, options = {}) {\n    super(collection, options);\n    this.options = {\n      ...options\n    };\n    delete this.options.writeConcern;\n    this.ns = ns;\n    if (typeof filter !== 'object' || Array.isArray(filter)) {\n      throw new error_1.MongoInvalidArgumentError('Query filter must be a plain object or ObjectId');\n    }\n    // special case passing in an ObjectId as a filter\n    this.filter = filter != null && filter._bsontype === 'ObjectId' ? {\n      _id: filter\n    } : filter;\n  }\n  get commandName() {\n    return 'find';\n  }\n  async execute(server, session) {\n    this.server = server;\n    const options = this.options;\n    let findCommand = makeFindCommand(this.ns, this.filter, options);\n    if (this.explain) {\n      findCommand = (0, utils_1.decorateWithExplain)(findCommand, this.explain);\n    }\n    return server.command(this.ns, findCommand, {\n      ...this.options,\n      ...this.bsonOptions,\n      documentsReturnedIn: 'firstBatch',\n      session\n    });\n  }\n}\nexports.FindOperation = FindOperation;\nfunction makeFindCommand(ns, filter, options) {\n  const findCommand = {\n    find: ns.collection,\n    filter\n  };\n  if (options.sort) {\n    findCommand.sort = (0, sort_1.formatSort)(options.sort);\n  }\n  if (options.projection) {\n    let projection = options.projection;\n    if (projection && Array.isArray(projection)) {\n      projection = projection.length ? projection.reduce((result, field) => {\n        result[field] = 1;\n        return result;\n      }, {}) : {\n        _id: 1\n      };\n    }\n    findCommand.projection = projection;\n  }\n  if (options.hint) {\n    findCommand.hint = (0, utils_1.normalizeHintField)(options.hint);\n  }\n  if (typeof options.skip === 'number') {\n    findCommand.skip = options.skip;\n  }\n  if (typeof options.limit === 'number') {\n    if (options.limit < 0) {\n      findCommand.limit = -options.limit;\n      findCommand.singleBatch = true;\n    } else {\n      findCommand.limit = options.limit;\n    }\n  }\n  if (typeof options.batchSize === 'number') {\n    if (options.batchSize < 0) {\n      if (options.limit && options.limit !== 0 && Math.abs(options.batchSize) < Math.abs(options.limit)) {\n        findCommand.limit = -options.batchSize;\n      }\n      findCommand.singleBatch = true;\n    } else {\n      findCommand.batchSize = options.batchSize;\n    }\n  }\n  if (typeof options.singleBatch === 'boolean') {\n    findCommand.singleBatch = options.singleBatch;\n  }\n  // we check for undefined specifically here to allow falsy values\n  // eslint-disable-next-line no-restricted-syntax\n  if (options.comment !== undefined) {\n    findCommand.comment = options.comment;\n  }\n  if (typeof options.maxTimeMS === 'number') {\n    findCommand.maxTimeMS = options.maxTimeMS;\n  }\n  const readConcern = read_concern_1.ReadConcern.fromOptions(options);\n  if (readConcern) {\n    findCommand.readConcern = readConcern.toJSON();\n  }\n  if (options.max) {\n    findCommand.max = options.max;\n  }\n  if (options.min) {\n    findCommand.min = options.min;\n  }\n  if (typeof options.returnKey === 'boolean') {\n    findCommand.returnKey = options.returnKey;\n  }\n  if (typeof options.showRecordId === 'boolean') {\n    findCommand.showRecordId = options.showRecordId;\n  }\n  if (typeof options.tailable === 'boolean') {\n    findCommand.tailable = options.tailable;\n  }\n  if (typeof options.oplogReplay === 'boolean') {\n    findCommand.oplogReplay = options.oplogReplay;\n  }\n  if (typeof options.timeout === 'boolean') {\n    findCommand.noCursorTimeout = !options.timeout;\n  } else if (typeof options.noCursorTimeout === 'boolean') {\n    findCommand.noCursorTimeout = options.noCursorTimeout;\n  }\n  if (typeof options.awaitData === 'boolean') {\n    findCommand.awaitData = options.awaitData;\n  }\n  if (typeof options.allowPartialResults === 'boolean') {\n    findCommand.allowPartialResults = options.allowPartialResults;\n  }\n  if (options.collation) {\n    findCommand.collation = options.collation;\n  }\n  if (typeof options.allowDiskUse === 'boolean') {\n    findCommand.allowDiskUse = options.allowDiskUse;\n  }\n  if (options.let) {\n    findCommand.let = options.let;\n  }\n  return findCommand;\n}\n(0, operation_1.defineAspects)(FindOperation, [operation_1.Aspect.READ_OPERATION, operation_1.Aspect.RETRYABLE, operation_1.Aspect.EXPLAINABLE, operation_1.Aspect.CURSOR_CREATING]);","map":{"version":3,"names":["error_1","require","read_concern_1","sort_1","utils_1","command_1","operation_1","FindOperation","CommandOperation","constructor","collection","ns","filter","options","writeConcern","Array","isArray","MongoInvalidArgumentError","_bsontype","_id","commandName","execute","server","session","findCommand","makeFindCommand","explain","decorateWithExplain","command","bsonOptions","documentsReturnedIn","exports","find","sort","formatSort","projection","length","reduce","result","field","hint","normalizeHintField","skip","limit","singleBatch","batchSize","Math","abs","comment","undefined","maxTimeMS","readConcern","ReadConcern","fromOptions","toJSON","max","min","returnKey","showRecordId","tailable","oplogReplay","timeout","noCursorTimeout","awaitData","allowPartialResults","collation","allowDiskUse","let","defineAspects","Aspect","READ_OPERATION","RETRYABLE","EXPLAINABLE","CURSOR_CREATING"],"sources":["../../src/operations/find.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}